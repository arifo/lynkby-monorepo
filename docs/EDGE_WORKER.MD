requirements spec for the wildcard public worker that serves creator pages at *.lynkby.com/*. This is the TikTok web-view first, ultra-fast, zero-JS renderer.

‚∏ª

#Ô∏è‚É£ Name & Scope
	‚Ä¢	Worker name: edge-public
	‚Ä¢	Routes (Cloudflare > Workers > Routes):
	‚Ä¢	*.lynkby.com/* ‚Üí edge-public (this spec)
	‚Ä¢	(Optional, same worker or a sibling): lynkby.com/u/* for path fallback
	‚Ä¢	Primary responsibility: SSR static HTML (no hydration/JS) for a creator‚Äôs public page using data from the API worker, with aggressive edge caching and TikTok web-view optimizations.

‚∏ª

üéØ Goals & Non-Goals

Goals
	‚Ä¢	TTFB (edge cache hit): < 50 ms
	‚Ä¢	Total HTML transfer < 10 KB (Brotli)
	‚Ä¢	Zero external assets; inline CSS only; no JS
	‚Ä¢	Stable layout: CLS ~ 0
	‚Ä¢	Works inside TikTok‚Äôs in-app web-view
	‚Ä¢	Safe defaults (robust headers, input validation)

Non-Goals (MVP)
	‚Ä¢	No per-link click tracking (will arrive Week 5)
	‚Ä¢	No custom domains (only *.lynkby.com)
	‚Ä¢	No dynamic layout system (single layout; theming via CSS vars)

‚∏ª

üß≠ Routing & Username Resolution
	‚Ä¢	Accept only *.lynkby.com hostnames.
	‚Ä¢	Extract username as the left-most label(s) before lynkby.com.
	‚Ä¢	E.g., bobo.lynkby.com ‚Üí username="bobo"
	‚Ä¢	Reject multi-dot usernames for MVP (e.g., john.doe.lynkby.com) ‚Üí 404
	‚Ä¢	Reserved subdomains ‚Üí 404:
	‚Ä¢	www, app, api, admin, support, blog, cdn, static, docs, pricing, status, dashboard, help, mail, dev, stage
	‚Ä¢	Allow only ^[a-z0-9_]{3,24}$ (lower-case); anything else ‚Üí 404
	‚Ä¢	Path handling on subdomains:
	‚Ä¢	/ ‚Üí render page
	‚Ä¢	Anything else (/robots.txt, /favicon.ico) ‚Üí handled (see Utilities); all other paths ‚Üí 404

‚∏ª

üîå Upstream Dependencies
	‚Ä¢	API base: https://api.lynkby.com/v1/public/page/by-username/:username
	‚Ä¢	200 ‚Üí page payload
	‚Ä¢	404 ‚Üí not found/unpublished
	‚Ä¢	No other networks (no fonts, no CSS, no JS CDNs).

Env Vars (bound in Worker)
	‚Ä¢	API_BASE="https://api.lynkby.com"
	‚Ä¢	RESERVED="www,app,api,admin,support,blog,cdn,static,docs,pricing,status,dashboard,help,mail,dev,stage"

‚∏ª

üì¶ Data Contract (from API)

{
  "username": "bobo",
  "displayName": "Bobo",
  "avatarUrl": "https://...",
  "bio": "Short bio‚Ä¶",
  "page": {
    "layout": "LINKS_LIST",
    "theme": "classic",
    "published": true,
    "updatedAt": "2025-09-03T08:40:00Z"
  },
  "links": [
    { "title":"Twitter", "url":"https://x.com/...", "active":true, "position":0 },
    { "title":"Shop", "url":"https://shop.com", "active":true, "position":1 }
  ]
}

Worker validations
	‚Ä¢	displayName, bio, title must be treated as plain text ‚Üí escape HTML.
	‚Ä¢	links: filter to active === true, sort by position.
	‚Ä¢	url allowlist schemes: https:, mailto:, tel: (drop otherwise).
	‚Ä¢	Empty lists ‚Üí render nothing (no gaps).

‚∏ª

üß† Caching Strategy

Edge cache (Cache API)
	‚Ä¢	Cache key: GET https://{username}.lynkby.com/
	‚Ä¢	Cache headers on HTML response:
	‚Ä¢	cache-control: max-age=60, s-maxage=300, stale-while-revalidate=86400
	‚Ä¢	Staleness policy: Serve cached for 60s to browser, 300s to edge; allow SWR for a day.

Freshness hint / soft versioning
	‚Ä¢	Use page.updatedAt to embed a version in <meta name="x-page-ver" content="..."> for diagnostics.
	‚Ä¢	(Optional later) include ?v={timestamp} in the API GET to help observability; do not include in cache key.

API fetch
	‚Ä¢	cf: { cacheTtl: 0, cacheEverything: false } (don‚Äôt cache API response at CF layer; we cache the rendered HTML)

‚∏ª

üñºÔ∏è HTML Rendering Rules (Zero-JS)

Layout
	‚Ä¢	Single column, centered, 360‚Äì420px, padding 24px.
	‚Ä¢	Inline CSS, system fonts only.
	‚Ä¢	Big tap targets (‚â•48px height); spacing 12‚Äì16px.

Theming (3 presets via CSS vars)
	‚Ä¢	classic (dark), contrast (light), warm (warm gray)
	‚Ä¢	Switch by adding data-theme="classic|contrast|warm" to <body> and setting CSS vars in a small :root block.

Accessibility
	‚Ä¢	Color contrast ‚â• WCAG AA (‚â• 4.5:1 for text).
	‚Ä¢	<img> with alt.
	‚Ä¢	Link focus outline visible.

SEO/OG (still minimal)
	‚Ä¢	<title>{displayName} | Lynkby</title>
	‚Ä¢	<meta name="description" content="{bio (truncated 160)}">
	‚Ä¢	OG tags: og:title, og:description, og:type=website
	‚Ä¢	Use avatarUrl as og:image only if same-origin or remote allows hotlinking; otherwise skip (MVP ok to include remote).

TikTok web-view specifics
	‚Ä¢	No external fonts (avoid FOIT).
	‚Ä¢	<meta name="format-detection" content="telephone=no">
	‚Ä¢	All links use target="_blank" rel="noopener" (TikTok opens in-app; noopener prevents access).
	‚Ä¢	No scripts, no iframes.

Example (structure)

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="format-detection" content="telephone=no">
  <title>{{displayName}} | Lynkby</title>
  <meta name="description" content="{{bio160}}">
  <meta property="og:title" content="{{displayName}} on Lynkby">
  <meta property="og:description" content="{{bio160}}">
  {{#if ogImage}}<meta property="og:image" content="{{ogImage}}">{{/if}}
  <meta name="x-page-ver" content="{{updatedAt}}">
  <link rel="icon" href="data:,">
  <style>/* ~1.5‚Äì2.5KB inline CSS; see CSS spec below */</style>
</head>
<body data-theme="{{theme}}">
  <main class="wrap">
    <section class="center">
      {{#if avatarUrl}}<img class="avatar" src="{{avatarUrl}}" alt="{{displayName}}"/>{{/if}}
      <h1 class="name">{{displayName}}</h1>
      {{#if bio}}<p class="bio">{{bio}}</p>{{/if}}
    </section>
    <nav>
      {{#each links}}
        {{#if active}}<a class="btn" href="{{url}}" target="_blank" rel="noopener">{{title}}</a>{{/if}}
      {{/each}}
    </nav>
    <footer class="foot">Made with Lynkby</footer>
  </main>
</body>
</html>

CSS spec (inline)
	‚Ä¢	Use CSS variables for theme:
	‚Ä¢	--bg, --fg, --muted, --btn, --btnText, --radius
	‚Ä¢	Base
	‚Ä¢	body { background:var(--bg); color:var(--fg); font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; }
	‚Ä¢	.wrap { max-width:420px; margin:0 auto; padding:24px 16px 64px; }
	‚Ä¢	.center { text-align:center; }
	‚Ä¢	.avatar { width:88px; height:88px; border-radius:50%; object-fit:cover; }
	‚Ä¢	.name { font-weight:700; font-size:22px; margin:12px 0 6px; }
	‚Ä¢	.bio { color:var(--muted); font-size:14px; margin:0 0 18px; }
	‚Ä¢	.btn { display:block; text-decoration:none; background:var(--btn); color:var(--btnText); border-radius:var(--radius); padding:14px 16px; margin:12px 0; text-align:center; font-weight:600; }
	‚Ä¢	.foot { margin-top:28px; opacity:.6; font-size:12px; text-align:center; }
	‚Ä¢	Themes
	‚Ä¢	[data-theme="classic"] { --bg:#0a0a0a; --fg:#f8f8f8; --muted:#b3b3b3; --btn:#1f1f1f; --btnText:#fff; --radius:12px; }
	‚Ä¢	[data-theme="contrast"] { --bg:#ffffff; --fg:#0c0c0c; --muted:#666; --btn:#f2f2f2; --btnText:#111; --radius:12px; }
	‚Ä¢	[data-theme="warm"] { --bg:#171513; --fg:#f5efe9; --muted:#c2b8ae; --btn:#2b2723; --btnText:#f5efe9; --radius:12px; }

‚∏ª

üõ°Ô∏è Security & Robustness

Input sanitization
	‚Ä¢	Validate host ends with .lynkby.com (case-insensitive).
	‚Ä¢	Username: regex ^[a-z0-9_]{3,24}$; check reserved list.
	‚Ä¢	404 for invalid or reserved.

Output escaping
	‚Ä¢	Escape displayName, bio, title for HTML.
	‚Ä¢	Truncate bio to 280 chars (160 for <meta>).
	‚Ä¢	Strip control characters.

Headers
	‚Ä¢	content-type: text/html; charset=utf-8
	‚Ä¢	x-content-type-options: nosniff
	‚Ä¢	referrer-policy: no-referrer
	‚Ä¢	frame-ancestors: 'none' (prevents clickjacking; note: our internal Preview overlay should load via same origin lynkby.com/u/:username route; this header applies to subdomain pages only.)
	‚Ä¢	permissions-policy: interest-cohort=()
	‚Ä¢	strict-transport-security: max-age=31536000; includeSubDomains; preload
	‚Ä¢	content-security-policy:

default-src 'none';
base-uri 'none';
img-src * data:;
style-src 'unsafe-inline';
connect-src 'none';
form-action 'none';
frame-ancestors 'none';
navigate-to *;

(No scripts at all.)

Rate limiting (light)
	‚Ä¢	Subdomain HTML: soft rate (e.g., allow bursts; CF edge usually fine). If needed, add IP token bucket per hostname (KV/DO not required for MVP).

Error handling
	‚Ä¢	404 page: tiny HTML (~1KB) with neutral message ‚ÄúPage not found‚Äù.
	‚Ä¢	5xx upstream ‚Üí return cached version if present; else a 502 minimal page. Include cf-ray id in a footer comment for debugging.

‚∏ª

üìà Observability

Response headers
	‚Ä¢	x-lynkby-username: {username}
	‚Ä¢	x-lynkby-cache: HIT|MISS (edge HTML cache)
	‚Ä¢	x-api-status: 200|404|5xx (last upstream status)
	‚Ä¢	x-page-ver: {updatedAt}

Sampling logs (10% sample)
	‚Ä¢	Log: { ts, ray, host, username, cache, apiStatus, durFetchMs, durRenderMs } via console.log (visible in CF Logs). Keep payload < 1KB.

‚∏ª

üß™ Acceptance Tests
	1.	Valid username:
	‚Ä¢	bobo.lynkby.com/ returns 200, renders name, links.
	‚Ä¢	Headers include security & cache headers.
	‚Ä¢	No external requests after initial HTML (DevTools ‚Äúrequests = 1‚Äù).
	2.	Reserved:
	‚Ä¢	www.lynkby.com/ returns 404 (for this worker; the apex is served elsewhere).
	3.	Invalid username:
	‚Ä¢	BOBO.lynkby.com/ ‚Üí case normalized; if not allowed by regex ‚Üí 404.
	4.	Empty content:
	‚Ä¢	If user has 0 active links ‚Üí renders header + footer only (no empty artifacts).
	5.	Cache behavior:
	‚Ä¢	First request: x-lynkby-cache: MISS
	‚Ä¢	Repeat within 60s: HIT and TTFB < 50ms (near your chosen edge POP).
	6.	Update propagation:
	‚Ä¢	After editor Save/Publish (API bumps updatedAt), live page shows new content within ‚â§ 60s (browser) / ‚â§ 5 min (edge), per headers.
	7.	TikTok web-view:
	‚Ä¢	Open via TikTok in-app browser: fonts are system, layout stable, links open without blocking (target=_blank, noopener).
	8.	Security:
	‚Ä¢	CSP blocks any <script> injection attempts (manually modify HTML locally to test).
	‚Ä¢	XSS attempt via title="<img onerror=alert(1)>‚Äù renders escaped text, not HTML.

‚∏ª

‚öôÔ∏è Pseudocode (Worker)

export default {
  async fetch(req, env, ctx) {
    const url = new URL(req.url);
    const host = url.hostname.toLowerCase();

    if (!host.endsWith(".lynkby.com")) return notFound();

    // Only root path on subdomain is supported
    if (url.pathname !== "/" && url.pathname !== "/robots.txt" && url.pathname !== "/favicon.ico")
      return notFound();

    if (url.pathname === "/robots.txt") return robots();
    if (url.pathname === "/favicon.ico") return tinyFavicon(); // data uri or 204

    const username = extractUsername(host);
    if (!username || isReserved(username, env)) return notFound();

    const cache = caches.default;
    const cacheKey = new Request(`https://${host}/`, { method: "GET" });

    const cached = await cache.match(cacheKey);
    if (cached) return withStdHeaders(cached, { cache: "HIT", username });

    // Miss ‚Üí fetch API
    const apiUrl = `${env.API_BASE}/v1/public/page/by-username/${encodeURIComponent(username)}`;
    const t0 = Date.now();
    const apiRes = await fetch(apiUrl, { cf: { cacheTtl: 0, cacheEverything: false }});
    const apiStatus = apiRes.status;
    if (apiStatus !== 200) return notFound({ username, apiStatus });

    const data = await apiRes.json();
    const html = renderHtml(data); // escape fields, apply theme, build buttons

    const res = new Response(html, {
      headers: {
        "content-type": "text/html; charset=utf-8",
        "cache-control": "max-age=60, s-maxage=300, stale-while-revalidate=86400",
        ...securityHeaders(data.page?.updatedAt)
      }
    });

    ctx.waitUntil(cache.put(cacheKey, res.clone()));
    return withStdHeaders(res, { cache: "MISS", username, apiStatus });
  }
};


‚∏ª

üß© Utilities to Implement
	‚Ä¢	extractUsername(host: string): string | null
	‚Ä¢	isReserved(name: string, env): boolean
	‚Ä¢	escapeHtml(s: string): string
	‚Ä¢	truncate(s: string, n: number): string
	‚Ä¢	securityHeaders(updatedAt?: string): Record<string,string>
	‚Ä¢	withStdHeaders(res: Response, meta: {cache:string, username:string, apiStatus?:number})
	‚Ä¢	Adds x-lynkby-username, x-lynkby-cache, x-api-status, x-page-ver
	‚Ä¢	robots() ‚Üí allow all (User-agent: *\nAllow: /\n)
	‚Ä¢	tinyFavicon() ‚Üí 204 No Content or tiny data URI
	‚Ä¢	notFound(meta?) ‚Üí minimal HTML + appropriate headers

‚∏ª

üöÄ Performance Budget Checklist
	‚Ä¢	Inline CSS ‚â§ 2.5 KB (Brotli)
	‚Ä¢	HTML total ‚â§ 10 KB (Brotli)
	‚Ä¢	No blocking fonts / JS
	‚Ä¢	s-maxage ‚â• 300s at edge; max-age ‚â• 60s for browsers
	‚Ä¢	Images unmodified (hotlink OK for MVP). If avatars cause slowness later, add an image proxy with resizing in a separate worker.

‚∏ª

üìù Future Hooks (Backlog)
	‚Ä¢	Click tracking via <a ping="/t"> (no JS) + single /t endpoint (rate-limited)
	‚Ä¢	Per-username purge endpoint signed with HMAC (when you want instant invalidation)
	‚Ä¢	Card/Grid layout (Week 6) toggled via page.layout
	‚Ä¢	OG image generator worker (R2/KV cached images)
	‚Ä¢	Custom domains (CNAME to apex) with HTTP challenge handling

‚∏ª

This is everything you need to implement the *.lynkby.com/* worker cleanly, safely, and fast for TikTok‚Äôs web-view‚Äîwhile leaving room for analytics and pro layouts later without re-architecting.


-----

The preview in the dashboard must render the exact same HTML as the public page. Here‚Äôs a clean way to guarantee 1:1 parity without copy-pasting templates (and with instant, cache-proof preview).

Plan: Single Source of Truth Renderer

1) Create a shared renderer package
	‚Ä¢	Workspace package: packages/public-renderer
	‚Ä¢	Export:

export type PublicPageData = {
  username: string
  displayName?: string
  avatarUrl?: string
  bio?: string
  page: { layout: 'LINKS_LIST'; theme: 'classic'|'contrast'|'warm'; published: boolean; updatedAt?: string }
  links: Array<{ title: string; url: string; active: boolean; position: number }>
}

export type RenderOptions = {
  // Controls CSP/frame policy differences between public page vs embedded preview
  mode: 'public' | 'embed'
  // Optional: used in diagnostics/meta
  requestHost?: string
}

export function renderHtml(data: PublicPageData, opts: RenderOptions): string
export function escapeHtml(s?: string, maxLen?: number): string


	‚Ä¢	Responsibilities:
	‚Ä¢	Build the full zero-JS HTML string (inline CSS, meta/OG, theme vars).
	‚Ä¢	Escape all user content (displayName, bio, link titles).
	‚Ä¢	Apply identical structure/styles for both public and preview.
	‚Ä¢	Accept mode to slightly adjust security headers (see below), not markup.

Used by:
	‚Ä¢	edge-public worker (*.lynkby.com/*)
	‚Ä¢	Dashboard (for server-rendered preview endpoint) OR the root worker (lynkby.com/preview/*)

This eliminates divergence and guarantees pixel parity.

‚∏ª

2) Headers & Embedding (CSP/frame-ancestors)

Your current public worker (subdomains) sets:
	‚Ä¢	frame-ancestors: 'none'  ‚ûú Good for public, but blocks preview if you iframe it.

Solution:
	‚Ä¢	Keep public subdomain strict.
	‚Ä¢	Add a dedicated preview endpoint on the root domain that relaxes only the frame policy:
	‚Ä¢	frame-ancestors: 'self' https://app.lynkby.com
	‚Ä¢	Or, if you insist on reusing the subdomain, support a strictly internal query flag:
	‚Ä¢	?embed=1&sig=<HMAC> ‚ûú When valid, return headers for embedding.
	‚Ä¢	Safer to keep preview on the root domain to avoid loosening subdomain security.

Header sets:

Public (subdomain, cacheable):

content-type: text/html; charset=utf-8
cache-control: max-age=60, s-maxage=300, stale-while-revalidate=86400
x-content-type-options: nosniff
referrer-policy: no-referrer
strict-transport-security: max-age=31536000; includeSubDomains; preload
content-security-policy:
  default-src 'none';
  base-uri 'none';
  img-src * data:;
  style-src 'unsafe-inline';
  connect-src 'none';
  form-action 'none';
  frame-ancestors 'none';
  navigate-to *;

Embed (root preview, non-cache or private cache):

content-type: text/html; charset=utf-8
cache-control: no-store   // or very small max-age to reflect drafts
x-content-type-options: nosniff
referrer-policy: no-referrer
strict-transport-security: max-age=31536000; includeSubDomains; preload
content-security-policy:
  default-src 'none';
  base-uri 'none';
  img-src * data:;
  style-src 'unsafe-inline';
  connect-src 'none';
  form-action 'none';
  frame-ancestors 'self' https://app.lynkby.com;
  navigate-to *;


‚∏ª

3) Preview Architecture (identical HTML, instant)

Option A (recommended): Root preview endpoint
	‚Ä¢	Route: lynkby.com/preview/:username
	‚Ä¢	Who serves it: the same edge worker (or a sibling) on the root domain.
	‚Ä¢	Data source: draft data from a private API (/v1/me/page/preview/:username) with dashboard auth ‚Üí the worker calls API with a short-lived bearer provided by the dashboard (or a worker-to-API service token).
	‚Ä¢	Cache: no-store (always fresh so the editor shows instant changes).
	‚Ä¢	Headers: embed mode (see above).
	‚Ä¢	Dashboard UI: iframe https://lynkby.com/preview/${username}?t=${Date.now()} (the t busts any intermediary caches if present).

Option B: Subdomain with signed embed
	‚Ä¢	Route: https://{username}.lynkby.com/?embed=1&sig=...
	‚Ä¢	Signature: HMAC over {username}.{ts} with a shared secret (sig=hex(hmacSHA256(secret, payload)), ts<=60s)
	‚Ä¢	Headers: embed mode only when signature valid; else public mode.
	‚Ä¢	Risk: mixing public and private concerns on subdomain. Option A is cleaner.

‚∏ª

4) Data: ‚ÄúDraft vs Published‚Äù

For preview to reflect unsaved or just-saved (but not yet cached) changes:
	‚Ä¢	API additions:
	‚Ä¢	GET /v1/me/page/preview/:username (auth required): returns exactly the same JSON shape as public, but from draft state (editor buffer) or the latest saved DB state (no publication check, no filtering).
	‚Ä¢	The renderer doesn‚Äôt care; it only needs the same contract.
	‚Ä¢	Editor flow:
	‚Ä¢	On each save, update DB and show preview iframe. No cache delays, because preview uses draft endpoint and no-store.
	‚Ä¢	Public page remains cache-friendly, updates visible within ~60s per your current policy.

‚∏ª

5) Worker wiring (who calls the renderer)

edge-public (subdomains)
	‚Ä¢	Extract username
	‚Ä¢	Fetch public API JSON
	‚Ä¢	Call renderHtml(data, { mode: 'public', requestHost: host })
	‚Ä¢	Return HTML + public headers
	‚Ä¢	Cache HTML at edge (as you already do)

root preview (dashboard iframe)
	‚Ä¢	Validate user session (cookie/JWT ‚Üí either verified in the API or via worker ‚Üí API)
	‚Ä¢	Fetch preview API JSON (auth)
	‚Ä¢	Call renderHtml(data, { mode: 'embed', requestHost: host })
	‚Ä¢	Return HTML + embed headers
	‚Ä¢	cache-control: no-store

The markup & CSS are identical, only headers and data source differ.

‚∏ª

6) Parity Guardrails (tests)
	‚Ä¢	Golden snapshot test in packages/public-renderer:
	‚Ä¢	Feed a fixed PublicPageData fixture
	‚Ä¢	Assert produced HTML snapshot (CI fails on unintended changes)
	‚Ä¢	Visual diff (optional): render the same HTML in a headless browser (Playwright) and screenshot both endpoints (/preview and subdomain mock); fail if pixels differ by > 1‚Äì2%.
	‚Ä¢	Contract test: Both endpoints must produce identical <body> innerHTML for the same input payload (strip <head> if meta differs only in CSP).

‚∏ª

7) Dashboard integration details
	‚Ä¢	Editor preview container: 375√ó667 px, border-radius 16, shadow; on desktop center it; on mobile make it full-width with max-height and scroll.
	‚Ä¢	Preview refresh triggers:
	‚Ä¢	After successful save ‚Üí refresh iframe src with updated ?t=${Date.now()}
	‚Ä¢	Manual ‚ÄúRefresh Preview‚Äù icon in the preview toolbar (helpful during theme tweaks)
	‚Ä¢	Fallback text: if preview load fails, show a tiny alert with a ‚ÄúOpen live page‚Äù link.

‚∏ª

8) Acceptance Criteria
	‚Ä¢	packages/public-renderer is the only source of HTML/CSS for public pages and preview.
	‚Ä¢	*.lynkby.com and lynkby.com/preview/:username produce identical markup for the same data (checked via tests).
	‚Ä¢	Preview loads instantly after save (no cache delay).
	‚Ä¢	Public page keeps fast caching; updates appear within your 60s window.
	‚Ä¢	Public pages cannot be embedded (frame-ancestors 'none'), preview can be embedded by the dashboard only.
	‚Ä¢	No external assets, no JS; HTML payload ‚â§ 10KB (brotli), CSS ‚â§ 2.5KB.
	‚Ä¢	All user strings are HTML-escaped in one place (renderer).
	‚Ä¢	Both endpoints pass the same accessibility/contrast checks.

‚∏ª

9) Minimal code skeletons

Renderer (package)

// packages/public-renderer/src/index.ts
export function renderHtml(data: PublicPageData, opts: RenderOptions): string {
  const esc = (s?: string, n?: number) => escapeHtml(s, n)
  const theme = data.page?.theme ?? 'classic'
  const updatedAt = data.page?.updatedAt ?? ''
  const safeLinks = (data.links ?? [])
    .filter(l => l?.active)
    .sort((a,b) => (a.position ?? 0) - (b.position ?? 0))
    .filter(l => /^https:|^mailto:|^tel:/.test(l.url || ''))

  // ‚Ä¶ build identical HTML with inline CSS (same as your public worker spec) ‚Ä¶
  return `<!doctype html>...`
}

Public worker uses it

import { renderHtml } from '@lynkby/public-renderer'

const html = renderHtml(data, { mode: 'public', requestHost: host })

Preview endpoint uses it

import { renderHtml } from '@lynkby/public-renderer'

const html = renderHtml(data, { mode: 'embed', requestHost: host })


‚∏ª

This setup keeps your preview and production perfectly in lock-step forever, while still honoring the different security and caching needs of each surface.