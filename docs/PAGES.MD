end-to-end implementation spec for what happens immediately after username creation:

‚∏ª

‚úÖ Scope
	‚Ä¢	Auto-create a default page for every new user.
	‚Ä¢	Serve live pages on https://{username}.lynkby.com (and canonical fallback https://lynkby.com/u/{username}).
	‚Ä¢	One simple layout (Links List) for MVP.
	‚Ä¢	API Worker handles all CRUD and onboarding init.
	‚Ä¢	Edge Worker renders public pages, handles subdomain routing, caching, and preview.

‚∏ª

1) Data Model (Prisma)

// users are already created by auth; add the fields below if missing
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  username     String   @unique
  displayName  String?
  avatarUrl    String?
  bio          String?  @db.VarChar(280)
  plan         Plan     @default(FREE) // FREE | PRO
  page         Page?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

enum Plan {
  FREE
  PRO
}

model Page {
  id            String   @id @default(cuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id])
  layout        Layout   @default(LINKS_LIST) // LINKS_LIST only for MVP
  theme         String   @default("classic")  // preset name; 2‚Äì3 presets in MVP
  published     Boolean  @default(true)
  updatedAt     DateTime @updatedAt
  createdAt     DateTime @default(now())
  // handy counters for simple analytics later
  viewsAllTime  Int      @default(0)
}

enum Layout {
  LINKS_LIST
}

model Link {
  id        String   @id @default(cuid())
  pageId    String
  page      Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  title     String   @db.VarChar(80)
  url       String   @db.VarChar(2048)
  active    Boolean  @default(true)
  position  Int      // 0,1,2‚Ä¶ for ordering
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pageId, position])
}

Business rules
	‚Ä¢	username is lowercase, [a-z0-9_], 3‚Äì24 chars, case-insensitive unique.
	‚Ä¢	Reserved usernames (block list): www, app, api, admin, support, blog, cdn, static, docs, pricing, status, dashboard, help, mail, dev, stage etc.
	‚Ä¢	1 page per user for MVP (enforced by Page.userId @unique).
	‚Ä¢	Default content on page creation:
	‚Ä¢	Links:
	1.	‚Äúüëã Welcome to my Lynkby‚Äù ‚Üí https://lynkby.com
	2.	‚Äúüí° Example link‚Äù ‚Üí https://example.com
	‚Ä¢	These show the user what it will look like and are easy to replace.

‚∏ª

2) API Worker (private + public JSON)

Base URL: https://api.lynkby.com/v1

Auth
	‚Ä¢	Use your existing session/JWT from magic link/OTP.
	‚Ä¢	Private endpoints require Authorization: Bearer <token>.

Endpoints

2.1 POST /setup/page

Idempotent. Creates the default page and two default links if the user has no page yet.

Req: (auth required)
{}

Res 200:

{
  "pageId": "pg_...",
  "username": "bobo",
  "liveUrl": "https://bobo.lynkby.com",
  "fallbackUrl": "https://lynkby.com/u/bobo"
}

Logic:
	‚Ä¢	If Page exists ‚Üí return existing (no duplicate).
	‚Ä¢	Else create:
	‚Ä¢	Page { layout: LINKS_LIST, theme: "classic", published: true }
	‚Ä¢	Link[] with two defaults (positions 0,1).

‚∏ª

2.2 GET /me/page

Returns the current user‚Äôs page + links (for dashboard editor).

Res 200:

{
  "page": {
    "id": "pg_...",
    "layout": "LINKS_LIST",
    "theme": "classic",
    "published": true,
    "updatedAt": "2025-09-03T08:40:00Z"
  },
  "profile": {
    "displayName": "Bobo",
    "avatarUrl": "https://...",
    "bio": "..."
  },
  "links": [
    {"id":"lnk1","title":"üëã Welcome to my Lynkby","url":"https://lynkby.com","active":true,"position":0},
    {"id":"lnk2","title":"üí° Example link","url":"https://example.com","active":true,"position":1}
  ],
  "liveUrl": "https://bobo.lynkby.com",
  "fallbackUrl": "https://lynkby.com/u/bobo"
}


‚∏ª

2.3 PUT /me/page

Update page meta + profile (NOT links).
Req:

{
  "displayName": "string?",
  "avatarUrl": "string?",
  "bio": "string?",
  "layout": "LINKS_LIST",   // MVP only
  "theme": "classic",       // one of preset names
  "published": true
}

Res 200: { "ok": true }

‚∏ª

2.4 POST /me/links/bulk-upsert

Replace the entire links array in one shot (best for simple editor).

Req:

{
  "links": [
    { "id": "lnk1", "title": "Twitter", "url": "https://x.com/...", "active": true, "position": 0 },
    { "title": "Shop", "url": "https://myshop.com", "active": true, "position": 1 } // new link (no id)
  ]
}

Rules:
	‚Ä¢	Server normalizes positions to 0..n in order received.
	‚Ä¢	Validates URL (must be https:// except phone/mailto).
	‚Ä¢	Max 50 links (MVP); future plan: unlimited on Pro.

Res 200: { "ok": true, "count": 12 }

‚∏ª

2.5 POST /me/publish

Soft ‚Äúpublish‚Äù action (no diff yet, but good hook to bump cache).
Res 200: { "ok": true }

Server side:
	‚Ä¢	Update Page.updatedAt = now().
	‚Ä¢	Emit a background event (optional) for analytics.

‚∏ª

2.6 GET /public/page/by-username/:username

Public JSON for Edge Worker to render.

Res 200:

{
  "username": "bobo",
  "displayName": "Bobo",
  "avatarUrl": "https://...",
  "bio": "Short bio up to 280 chars",
  "page": { "layout":"LINKS_LIST", "theme":"classic", "published":true, "updatedAt":"2025-09-03T08:40:00Z" },
  "links": [
    {"title":"Twitter","url":"https://x.com/...","active":true,"position":0},
    {"title":"Shop","url":"https://shop.com","active":true,"position":1}
  ]
}

Res 404: { "error": "NOT_FOUND" } (also for unpublished).

‚∏ª

2.7 (Optional for later) POST /public/track
	‚Ä¢	Minimal anonymous events { type: "page_view" | "link_click", username, linkIndex? }
	‚Ä¢	Rate-limit per IP.

‚∏ª

3) Edge Worker (public pages, subdomain routing, caching)

Routes (Cloudflare Workers ‚Üí Routes):
	‚Ä¢	lynkby.com/* ‚Üí Edge Worker
	‚Ä¢	*.lynkby.com/* ‚Üí Edge Worker
	‚Ä¢	app.lynkby.com/* ‚Üí (Pages/Next.js dashboard as you already set)
	‚Ä¢	api.lynkby.com/* ‚Üí API Worker

DNS:
	‚Ä¢	One wildcard DNS record *.lynkby.com proxied (orange cloud).
	‚Ä¢	Apex lynkby.com proxied, too.
	‚Ä¢	No per-username DNS needed; the worker resolves dynamically.

Request handling (pseudocode)

export default {
  async fetch(req, env, ctx) {
    const url = new URL(req.url);
    const host = url.hostname;            // e.g., "bobo.lynkby.com"
    const isRoot = host === "lynkby.com" || host === "www.lynkby.com";

    // 1) Static assets / robots
    if (url.pathname === "/robots.txt") return new Response("User-agent: *\nAllow: /\n", { headers: { "content-type":"text/plain" }});

    // 2) Fallback path-based user pages: lynkby.com/u/{username}
    if (isRoot && url.pathname.startsWith("/u/")) {
      const username = url.pathname.split("/")[2]?.toLowerCase();
      return renderUserPage(username, env, req);
    }

    // 3) Subdomain-based user pages: {username}.lynkby.com
    const parts = host.split(".");
    if (parts.length >= 3 && parts[parts.length-2] === "lynkby" && parts[parts.length-1] === "com") {
      const username = parts.slice(0, parts.length - 2).join(".").toLowerCase();
      return renderUserPage(username, env, req);
    }

    // 4) Marketing site (root) ‚Üí pass-through or static HTML
    return renderMarketingLanding(); // ultra-light HTML or redirect to www
  }
}

async function renderUserPage(username, env, req) {
  if (!username || isReserved(username)) return notFound();

  const cache = caches.default;
  const cacheKey = new Request(new URL("/", `https://${username}.lynkby.com`).toString(), { method: "GET" });
  const cached = await cache.match(cacheKey);
  if (cached) return cached;

  const apiUrl = `${env.API_BASE}/v1/public/page/by-username/${encodeURIComponent(username)}`;
  const apiRes = await fetch(apiUrl, { cf: { cacheTtl: 0, cacheEverything: false }});
  if (apiRes.status !== 200) return notFound();
  const data = await apiRes.json();

  const html = renderHtml(data); // SSR template string (see below)
  const res = new Response(html, {
    headers: {
      "content-type": "text/html; charset=utf-8",
      // Fast edge + safe freshness:
      "cache-control": "max-age=60, s-maxage=60, stale-while-revalidate=86400"
    }
  });

  // put in edge cache
  await cache.put(cacheKey, res.clone());
  return res;
}

Invalidation approach (MVP): Keep TTL 60s (max-age=60, s-maxage=60). When the user hits Publish or Save, you don‚Äôt need hard purge‚Äînew content is visible within a minute. Later you can add a versioned cache key (e.g., ?v=updatedAt).

HTML renderer (ultra-light, TikTok-friendly)
	‚Ä¢	No external CSS, system fonts, inline CSS only, large tap targets.
	‚Ä¢	360‚Äì420px content width, 16px base size, 48‚Äì56px link buttons.
	‚Ä¢	Minimal CLS (avoid web fonts), lazy-load avatar, OG meta.

<!-- renderHtml(data) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>{{displayName}} | Lynkby</title>
  <meta property="og:title" content="{{displayName}} on Lynkby">
  <meta property="og:description" content="{{bio}}">
  <meta property="og:type" content="website">
  <link rel="icon" href="data:,">
  <style>
    :root { --bg:#0a0a0a; --fg:#f8f8f8; --muted:#b3b3b3; --btn:#1f1f1f; --bd:12px; }
    body { margin:0; background:var(--bg); color:var(--fg); font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    .wrap { max-width:420px; margin:0 auto; padding:24px 16px 64px; }
    .center { text-align:center; }
    .avatar { width:88px; height:88px; border-radius:50%; object-fit:cover; }
    .name { font-weight:700; font-size:22px; margin:12px 0 6px; }
    .bio { color:var(--muted); font-size:14px; margin-bottom:18px; }
    .btn { display:block; text-decoration:none; color:var(--fg); background:var(--btn); border-radius:var(--bd);
           padding:14px 16px; margin:12px 0; text-align:center; font-weight:600; }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="center">
      {{#if avatarUrl}}<img class="avatar" src="{{avatarUrl}}" alt="{{displayName}}"/>{{/if}}
      <div class="name">{{displayName}}</div>
      {{#if bio}}<div class="bio">{{bio}}</div>{{/if}}
    </section>
    <nav>
      {{#each links}}
        {{#if active}}<a class="btn" href="{{url}}" rel="noopener" target="_blank">{{title}}</a>{{/if}}
      {{/each}}
    </nav>
  </main>
</body>
</html>


‚∏ª

4) Dashboard UI (first session after username)

Route: app.lynkby.com/dashboard

First-time state (after /setup/page)
	‚Ä¢	Success bar: ‚ÄúYour page is live ‚Üí https://{username}.lynkby.com [Copy] [Open]‚Äù
	‚Ä¢	Profile Card
	‚Ä¢	Avatar URL (paste only in Week 1)
	‚Ä¢	Display Name
	‚Ä¢	Bio (max 280)
	‚Ä¢	Links Editor
	‚Ä¢	List rows: Title, URL, toggle (Active), drag handle (later), delete
	‚Ä¢	‚ÄúAdd Link‚Äù primary action ‚Üí appends new row at bottom
	‚Ä¢	Theme (MVP)
	‚Ä¢	Radio: classic, contrast, warm (FREE)
	‚Ä¢	Publish bar
	‚Ä¢	‚ÄúSave‚Äù (primary)
	‚Ä¢	‚ÄúView live‚Äù
	‚Ä¢	Info text: ‚ÄúChanges appear within ~60s‚Äù

Detailed UX
	‚Ä¢	Validation:
	‚Ä¢	Title required, 1‚Äì80 chars.
	‚Ä¢	URL must be valid https:// (allow mailto: tel:).
	‚Ä¢	Errors inline under field.
	‚Ä¢	Optimistic UI (local reorder), server normalizes positions.

Copy CTA
	‚Ä¢	‚ÄúCopy your link in bio‚Äù ‚Üí copies https://{username}.lynkby.com

Preview mode
	‚Ä¢	Toggle ‚ÄúPreview (TikTok)‚Äù ‚Üí constrains viewport to 375√ó667 container with the same HTML theme (iframe calling lynkby.com/u/{username}).

‚∏ª

5) Business Logic & Flow

Post-Username creation (client app flow)
	1.	Client calls POST /v1/setup/page.
	2.	API returns live & fallback URLs.
	3.	Dashboard shows the default editor state with 2 prefilled links.
	4.	On every Save:
	‚Ä¢	PUT /v1/me/page (profile/meta)
	‚Ä¢	POST /v1/me/links/bulk-upsert (links)
	‚Ä¢	(Optional) POST /v1/me/publish (bumps updatedAt; future cache versioning hook)
	5.	User clicks View live ‚Üí opens https://{username}.lynkby.com.

Public serving
	‚Ä¢	Edge Worker:
	‚Ä¢	Subdomain or /u/{username} path.
	‚Ä¢	Fetches /v1/public/page/by-username/:username.
	‚Ä¢	Renders inline HTML.
	‚Ä¢	Caches for 60s (stale-while-revalidate 1 day).

Reserved / not found
	‚Ä¢	If user hits an unavailable username subdomain ‚Üí minimal 404 page.

‚∏ª

6) Validation & Security
	‚Ä¢	Username policy enforced at creation & on every request that uses username to fetch.
	‚Ä¢	Public endpoint only returns when Page.published = true.
	‚Ä¢	Rate limit GET /public/... (per IP) at Worker level (e.g., 1000 req / 5 min).
	‚Ä¢	CORS: Public endpoints allow GET from anywhere; private endpoints ‚Üí same origin (dashboard) only.
	‚Ä¢	XSS: Escape displayName, bio, title (no HTML allowed).
	‚Ä¢	URLs: Server-side sanitize & allowlist schemes.

‚∏ª

7) Cloudflare & Env

Edge Worker env:
	‚Ä¢	API_BASE = "https://api.lynkby.com"
	‚Ä¢	(Optional) MARKETING_HTML embedded or static pass-through

API Worker env:
	‚Ä¢	DATABASE_URL (Neon pooled via Hyperdrive for runtime)
	‚Ä¢	DIRECT_URL (Neon direct for migrations)
	‚Ä¢	JWT_PUBLIC_KEY / session secret
	‚Ä¢	ALLOWED_ORIGINS = "https://app.lynkby.com"

Routes (Workers):
	‚Ä¢	Edge Worker: lynkby.com/*, *.lynkby.com/*
	‚Ä¢	API Worker: api.lynkby.com/*

Neon + Prisma
	‚Ä¢	Run migrations locally against DIRECT_URL.
	‚Ä¢	Worker runtime uses pooled DATABASE_URL (Hyperdrive) for scalability.

‚∏ª

8) Acceptance Criteria (MVP)
	‚Ä¢	New user finishes username ‚Üí /setup/page auto-creates a page with 2 links.
	‚Ä¢	https://{username}.lynkby.com is reachable within seconds (wildcard subdomain; no per-user DNS).
	‚Ä¢	https://lynkby.com/u/{username} shows identical content.
	‚Ä¢	Dashboard editor can:
	‚Ä¢	Update displayName, avatarUrl, bio
	‚Ä¢	Add/remove/toggle/reorder links (positions normalized)
	‚Ä¢	Save without errors; invalid fields show clear messages
	‚Ä¢	Copy live URL
	‚Ä¢	Edge page loads < 100ms TTFB at the edge (after cached) and minimal CLS.
	‚Ä¢	HTML is self-contained (no blocking external assets).
	‚Ä¢	Cache freshness: content updates visible within ‚â§60s.
	‚Ä¢	Reserved usernames 404 on subdomain.
	‚Ä¢	Public JSON hides unpublished pages.

‚∏ª

9) Nice-to-have (keep in backlog)
	‚Ä¢	Hard cache purge endpoint (HMAC-signed) that deletes caches for a username.
	‚Ä¢	‚ÄúCopy in 1 tap‚Äù deep link for TikTok app (with UTM).
	‚Ä¢	Link click tracking endpoint with per-IP debounce (for Week 5).
	‚Ä¢	Card/Grid layout (gated for Pro).
	‚Ä¢	Theme editor (Week 6).

‚∏ª
